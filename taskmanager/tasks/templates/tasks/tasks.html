{% extends 'tasks/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "My Tasks" %}{% endblock %}

{% block content %}
<div class="container py-4">
    <h2 class="mb-4 text-center"><i class="bi bi-stickies-fill"></i> {% trans "My Tasks" %}</h2>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="{% url 'task_create' %}" class="btn btn-primary"><i class="bi bi-plus-lg"></i> {% trans "New Task" %}</a>
        <form method="get" class="row mb-4 g-2">
            <div class="col-md-4">
              <input type="text" name="q" value="{{ query|default_if_none:'' }}" class="form-control" placeholder="{% trans "Search by title" %}">
            </div>
            <div class="col-md-4">
              <select name="status" class="form-select">
                <option value="">{% trans "All statuses" %}</option>
                <option value="pending" {% if status_filter == 'pending' %}selected{% endif %} title="{% trans 'Pending' %}">{% trans "Pending" %}</option>
                <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %} title="{% trans 'In Progress' %}">{% trans "In Progress" %}</option>
                <option value="completed" {% if status_filter == 'completed' %}selected{% endif %} title="{% trans 'Completed' %}">{% trans "Completed" %}</option>
              </select>
            </div>
            <div class="col-md-4 d-grid">
              <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i> {% trans "Apply" %}</button>
            </div>
        </form>
    </div>

    {% if tasks %}
        <ul class="list-group">
            {% for task in tasks %}
              <li class="list-group-item mb-3 shadow rounded
                {{ task.card_highlight }}"
                id="task-{{ task.id }}"
                data-task-id="{{ task.id }}"
                data-due-date="{{ task.due_date|date:'Y-m-d' }}"
                data-has-description="{% if task.description %}true{% else %}false{% endif %}"
                data-status="{{ task.status }}"
                style="cursor: pointer;"
              >
                <div class="d-flex justify-content-between flex-wrap">
                  <!-- Left part: info -->
                  <div class="flex-grow-1 me-3">

                    <!-- Title + Due date -->
                    <div class="d-flex justify-content-between align-items-center">
                      <h5 class="mb-1">
                        <i class="bi bi-sticky-fill text-primary me-1"></i>{{ task.title }}
                      </h5>
                      {% if task.due_date %}
                        <div class="due-date-display {{ task.due_highlight }} mb-2">
                          <i class="bi bi-calendar-event me-1"></i> {% trans "Due by:" %} {{ task.due_date|date:"d.m.Y" }}
                        </div>
                      {% endif %}
                    </div>
                
                    <!-- Status -->
                    <div class="mb-2">
                      <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>{% trans "Status:" %} <strong class="status-display">{{ task.get_status_display }}</strong>
                      </small>
                    </div>
                
                    <!-- Status buttons -->
                    <div class="btn-group status-btns mb-2" data-task-id="{{ task.id }}">
                      <button type="button"
                              class="btn btn-sm {% if task.status == 'pending' %}btn-secondary{% else %}btn-outline-secondary{% endif %}"
                              data-status="pending"
                              title="{% trans 'Pending' %}">
                        <i class="bi bi-hourglass-split"></i>
                      </button>
                      <button type="button"
                              class="btn btn-sm {% if task.status == 'in_progress' %}btn-warning{% else %}btn-outline-warning{% endif %}"
                              data-status="in_progress"
                              title="{% trans 'In Progress' %}">
                        <i class="bi bi-clock-fill"></i>
                      </button>
                      <button type="button"
                              class="btn btn-sm {% if task.status == 'completed' %}btn-success{% else %}btn-outline-success{% endif %}"
                              data-status="completed"
                              title="{% trans 'Completed' %}">
                        <i class="bi bi-check-circle-fill"></i>
                      </button>
                    </div>
                
                    <!-- Tags -->
                    {% if task.tags.all %}
                      <div class="mt-1">
                        {% for tag in task.tags.all %}
                          <span class="badge bg-info text-dark me-1">
                            <i class="bi bi-tag-fill me-1"></i>{{ tag.name }}
                          </span>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
              
                  <!-- Right part: actions -->
                  <div class="text-end mt-2 mt-md-0">
                    <a href="{% url 'task_edit' task.id %}" class="btn btn-sm btn-warning mb-2 w-100">
                      <i class="bi bi-pencil-fill me-1"></i> {% trans "Edit" %}
                    </a>
                    <button class="btn btn-sm btn-danger w-100 delete-task-btn" data-task-id="{{ task.id }}">
                      <i class="bi bi-trash-fill me-1"></i> {% trans "Delete" %}
                    </button>
                  </div>

                </div>
                {% if task.description %}
                    <div class="task-description mt-2 collapse-description">
                        <hr>
                        <p class="mb-0">{% trans "Description:" %} {{ task.description }}</p>
                    </div>
                {% endif %}
              </li>
            {% endfor %}
        </ul>
    {% else %}
        <div class="alert alert-light text-center" role="alert">
            <i class="bi bi-emoji-frown"></i> {% trans "No tasks found." %}
        </div>
    {% endif %}
</div>

{% if not user.telegramprofile.chat_id %}
<div class="alert alert-info">
  {% trans "Want to receive notifications in Telegram?" %} 
  <a href="https://t.me/TaskinoTaskmanager_bot">{% trans "Link your account" %}</a>
</div>
{% endif %}

<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteConfirmModalLabel">{% trans "Delete Confirmation" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans "Close" %}"></button>
      </div>
      <div class="modal-body">
        {% trans "Are you sure you want to delete this task?" %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">{% trans "Delete" %}</button>
      </div>
    </div>
  </div>
</div>

<style>
  .collapse-description {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease;
  }

  .collapse-description.expanded {
    max-height: 300px; /* adjust as needed */
  }
</style>
{% endblock %}

{% block scripts %}
    <script src="{% static 'tasks/js/status_update.js' %}"></script>
    <script src="{% static 'tasks/js/tasks_description_animation.js' %}"></script>
    <script src="{% static 'tasks/js/confirmation_window.js' %}"></script>
{% endblock %}
